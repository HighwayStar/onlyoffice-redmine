<%#
# (c) Copyright Ascensio System SIA 2022
# http://www.onlyoffice.com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
%>

<p>
  <%= content_tag(:label, l(:onlyoffice_settings_doc_url)) %>
  <%= text_field_tag 'settings[oo_address]', settings['oo_address'] %>
</p>
<p>
  <%= content_tag(:label, l(:onlyoffice_settings_jwtsecret)) %>
  <%= text_field_tag 'settings[jwtsecret]', settings['jwtsecret'] %>
</p>

<fieldset>
  <legend>
    <span><%= l(:onlyoffice_settings_editor_view) %></span>
  </legend>
  <label class="floating">
    <%= check_box_tag 'settings[editor_chat]', settings['editor_chat'], settings['editor_chat'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_chat) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_compact_header]', settings['editor_compact_header'], settings['editor_compact_header'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_header) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_feedback]', settings['editor_feedback'], settings['editor_feedback'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_feedback) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_help]', settings['editor_help'], settings['editor_help'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_help) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_toolbar_no_tabs]', settings['editor_toolbar_no_tabs'], settings['editor_toolbar_no_tabs'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_toolbar) %>
  </label>
</fieldset>

<script type="text/javascript" language="javascript">
    document.getElementsByClassName("box tabular settings")[0].classList.remove("settings")
</script>

<div id="error-notification">
  <div class="flash error" style="display: none"><%= l(:onlyoffice_editor_cannot_be_reached) %></div>
  <div id="iframeEditor"></div>
</div>


<div style="display: none">
  <%= stylesheet_link_tag "editor", :plugin => "onlyoffice_redmine" %>

  <%= 
    editor_base_url = Setting.plugin_onlyoffice_redmine["oo_address"]
    editor_base_jwtsecret = Setting.plugin_onlyoffice_redmine["jwtsecret"]
    is_connection = true
    is_command = ""
    begin
      res_health = CallbackHelper.do_request(editor_base_url + "healthcheck")
      res_command = CallbackHelper.command_request("version")
      is_command += res_command["version"]
    rescue
      is_connection = false
    end
  %>

  <script src="<%= editor_base_url[-1].eql?("/") ? editor_base_url : editor_base_url + "/" %>web-apps/apps/api/documents/api.js"></script>

  <script type="text/javascript" language="javascript">
    document.getElementById("content").prepend(document.getElementById("error-notification"));

    var connectEditor = function () {
        if (typeof DocsAPI === "undefined" || !<%= is_connection %> || <%= is_command.empty? %>) {
          document.getElementById("error-notification").children[0].style.display = "block";
          return;
        }else {
          document.getElementById("error-notification").children[0].style.display = "none";
        }
    };
    
    if (window.addEventListener) {
        window.addEventListener("load", connectEditor);
    } else if (window.attachEvent) {
        window.attachEvent("load", connectEditor);
    }
  </script>
</div>




