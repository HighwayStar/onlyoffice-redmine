<%#
# (c) Copyright Ascensio System SIA 2022
# http://www.onlyoffice.com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
%>

<p>
  <%= content_tag(:label, l(:onlyoffice_settings_doc_url)) %>
  <%= text_field_tag 'settings[oo_address]', settings['oo_address'] %>
</p>
<p>
  <%= content_tag(:label, l(:onlyoffice_settings_jwtsecret)) %>
  <%= text_field_tag 'settings[jwtsecret]', settings['jwtsecret'] %>
</p>
<fieldset>
  <legend>
    <span><%= l(:onlyoffice_additional_settings) %></span>
  </legend>
  <p>
    <%= content_tag(:label, l(:onlyoffice_additional_settings_editor)) %>
    <%= text_field_tag 'settings[inner_editor]', settings['inner_editor'], :placeholder => "http://docserver/" %>
  </p>
  <p>
    <%= content_tag(:label, l(:onlyoffice_additional_settings_server)) %>
    <%= text_field_tag 'settings[inner_server]', settings['inner_server'], :placeholder => "http://redmine/" %>
  </p>
</fieldset>
<fieldset>
  <legend>
    <span><%= l(:onlyoffice_settings_editor_view) %></span>
  </legend>
  <label class="floating">
    <%= check_box_tag 'settings[editor_demo]', settings['editor_demo'], settings['editor_demo'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_demo) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_chat]', settings['editor_chat'], settings['editor_chat'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_chat) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_compact_header]', settings['editor_compact_header'], settings['editor_compact_header'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_header) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_feedback]', settings['editor_feedback'], settings['editor_feedback'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_feedback) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_help]', settings['editor_help'], settings['editor_help'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_help) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[editor_toolbar_no_tabs]', settings['editor_toolbar_no_tabs'], settings['editor_toolbar_no_tabs'].eql?('on') %>
    <%= l(:onlyoffice_settings_editor_view_toolbar) %>
  </label>
  <label class="floating">
    <%= check_box_tag 'settings[check_cert]', settings['check_cert'], settings['check_cert'].eql?('on') %>
    <%= l(:onlyoffice_settings_check_cert) %>
  </label>
</fieldset>

<div id="onlyoffice-error-notification" style="display: none">
  <div class="flash error"></div>
</div>

<script type="text/javascript" language="javascript">
    document.getElementsByClassName("box tabular settings")[0].classList.remove("settings");

    var contentDiv = document.getElementById("content");
    contentDiv.insertBefore($("#onlyoffice-error-notification")[0], document.getElementsByTagName("h2")[0]);
</script>

<script type="text/javascript" language="javascript">
    var showError = function (errorMes) {
        if ($("#flash_notice")[0]) $("#flash_notice")[0].remove();
        let notice = $("#onlyoffice-error-notification")[0];
        notice.style.display = "block";
        notice.children[0].innerText = errorMes;
        $('#settings form input[type=submit]')[0].disabled = false;
    };

    var checkSettings = function () {
        var scriptCallback = function () {
            var resultScript = typeof DocsAPI !== "undefined";
            if (!resultScript) {
                showError("<%= l(:onlyoffice_editor_cannot_be_reached) %>");
            } else {
                $.ajax({
                    type: 'POST',
                    url: '<%= onlyoffice_check_settings_path %>',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(data)
                }).always(function (result, textStatus, jqXHR) {
                    let ok = result !== 'false';
                    if (ok) {
                        $('#settings form')[0].submit();
                    } else showError("<%= l(:onlyoffice_editor_cannot_be_reached) %>");
                });
            }
        };
        $("#onlyoffice-error-notification")[0].style.display = "none";

        var cert = $("#settings_check_cert")[0].checked;
        var editor_url = $("#settings_oo_address")[0].value;
        editor_url += editor_url.charAt(editor_url.length - 1) === '/' ? '' : '/';
        var secret = $("#settings_jwtsecret")[0].value;
        if ($('#settings_editor_demo')[0].checked) {
          editor_url = `<%= Config.get_config("oo_address") %>`;
          secret = '<%= Config.get_config("jwtsecret") %>';
        }
        var data = {
            url: editor_url,
            secret: secret,
            cert: cert
        };
        delete DocsAPI;
        var scriptAddress = document.getElementById("scriptDocServiceAddress");
        if (scriptAddress) scriptAddress.parentNode.removeChild(scriptAddress);
        var script = document.createElement('script');
        script.id = "scriptDocServiceAddress";
        script.type = 'text/javascript';
        document.head.appendChild(script);
        scriptAddress = document.getElementById("scriptDocServiceAddress");
        scriptAddress.onload = scriptCallback;
        scriptAddress.onerror = scriptCallback;
        scriptAddress.src = editor_url + "web-apps/apps/api/documents/api.js";
    };

    var ele = $('#settings form')[0];
    var settingsCallback = function (e) {
        e.preventDefault();
        checkSettings();
    };

    var changing_activity_fields  = function (bool) {
      document.getElementById("settings_oo_address").disabled = bool
      document.getElementById("settings_jwtsecret").disabled = bool
    };

    $(document).ready(function () {
      if (<%= Setting.plugin_onlyoffice_redmine["editor_demo"].eql?("on") %>) {
        if (<%= Config.istrial %>){
          document.getElementById("onlyoffice-error-notification").children[0].style.display = "none";
          changing_activity_fields(true);
        } else {
          showError("<%= l(:onlyoffice_editor_trial_period_ended) %>");
          document.getElementById("settings_editor_demo").checked = false;
        }
      }

      <%
        if Config.istrial_at_settings
          Setting.plugin_onlyoffice_redmine["editor_demo"] = ""
        end
      %>
      
      var demoCheckBox = $('#settings_editor_demo')[0];
      demoCheckBox.onclick = function () {
        if (<%= Config.istrial_at_settings %>) {
          demoCheckBox.checked = false;
          demoCheckBox.disabled = true;
        }
        if (demoCheckBox.disabled == false) {
          if (demoCheckBox.checked) {
            changing_activity_fields(true);
          } else {
            changing_activity_fields(false);
          }
        } else {
          showError("<%= l(:onlyoffice_editor_trial_period_ended) %>");
        }
      }
    });

    if(ele.addEventListener){
        ele.addEventListener("submit", settingsCallback, false);
    } else if(ele.attachEvent){
        ele.attachEvent('onsubmit', settingsCallback);
    }
</script>
